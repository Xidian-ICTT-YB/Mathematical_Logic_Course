# 导入Z3求解器库
from z3 import *

# ======================================
# 1. 变量声明与约束建模
# ======================================
# 批量声明24个整数变量（x[0]~x[23]，对应题目中的s0~s23）
n = 24
x = [Int('s' + str(i)) for i in range(n)]

# 创建求解器实例
solver = Solver()

# 2. 添加核心约束：题目给出的22个线性方程组
solver.add(
    # 第一组方程（变量x[2],x[3],x[4],x[5],x[6],x[7]）
    245 * x[6] + 395 * x[5] + 3541 * x[4] + 2051 * x[3] + 3201 * x[2] + 1345 * x[7] == 855009,
    3270 * x[6] + 3759 * x[5] + 3900 * x[4] + 3963 * x[3] + 1546 * x[2] + 3082 * x[7] == 1515490,
    526 * x[6] + 2283 * x[5] + 3349 * x[4] + 2458 * x[3] + 2012 * x[2] + 268 * x[7] == 854822,
    3208 * x[6] + 2021 * x[5] + 3146 * x[4] + 1571 * x[3] + 2569 * x[2] + 1395 * x[7] == 1094422,
    3136 * x[6] + 3553 * x[5] + 2997 * x[4] + 1824 * x[3] + 1575 * x[2] + 1599 * x[7] == 1136398,
    2300 * x[6] + 1349 * x[5] + 86 * x[4] + 3672 * x[3] + 2908 * x[2] + 1681 * x[7] == 939991,

    # 第二组方程（变量x[8],x[9],x[10],x[11],x[12],x[20],x[21],x[22],x[23]）
    212 * x[22] + 153 * x[21] + 342 * x[20] + 490 * x[12] + 325 * x[11] + 485 * x[10] + 56 * x[9] + 202 * x[8] + 191 *
    x[23] == 245940,
    348 * x[22] + 185 * x[21] + 134 * x[20] + 153 * x[12] + 460 * x[9] + 207 * x[8] + 22 * x[10] + 24 * x[11] + 22 * x[
        23] == 146392,
    177 * x[22] + 231 * x[21] + 489 * x[20] + 339 * x[12] + 433 * x[11] + 311 * x[10] + 164 * x[9] + 154 * x[8] + 100 *
    x[23] == 239438,
    68 * x[20] + 466 * x[12] + 470 * x[11] + 22 * x[10] + 270 * x[9] + 360 * x[8] + 337 * x[21] + 257 * x[22] + 82 * x[
        23] == 233887,
    246 * x[22] + 235 * x[21] + 468 * x[20] + 91 * x[12] + 151 * x[11] + 197 * x[8] + 92 * x[9] + 73 * x[10] + 54 * x[
        23] == 152663,
    241 * x[22] + 377 * x[21] + 131 * x[20] + 243 * x[12] + 233 * x[11] + 55 * x[10] + 376 * x[9] + 242 * x[8] + 343 *
    x[23] == 228375,
    356 * x[22] + 200 * x[21] + 136 * x[11] + 301 * x[10] + 284 * x[9] + 364 * x[8] + 458 * x[12] + 5 * x[20] + 61 * x[
        23] == 211183,
    154 * x[22] + 55 * x[21] + 406 * x[20] + 107 * x[12] + 80 * x[10] + 66 * x[8] + 71 * x[9] + 17 * x[11] + 71 * x[
        23] == 96788,
    335 * x[22] + 201 * x[21] + 197 * x[11] + 280 * x[10] + 409 * x[9] + 56 * x[8] + 494 * x[12] + 63 * x[20] + 99 * x[
        23] == 204625,

    # 第三组方程（变量x[13],x[14],x[15],x[16],x[17],x[18],x[19]）
    428 * x[18] + 1266 * x[17] + 1326 * x[16] + 1967 * x[15] + 3001 * x[14] + 81 * x[13] + 2439 * x[19] == 1109296,
    2585 * x[18] + 4027 * x[17] + 141 * x[16] + 2539 * x[15] + 3073 * x[14] + 164 * x[13] + 1556 * x[19] == 1368547,
    2080 * x[18] + 358 * x[17] + 1317 * x[16] + 1341 * x[15] + 3681 * x[14] + 2197 * x[13] + 1205 * x[19] == 1320274,
    840 * x[18] + 1494 * x[17] + 2353 * x[16] + 235 * x[15] + 3843 * x[14] + 1496 * x[13] + 1302 * x[19] == 1206735,
    101 * x[18] + 2025 * x[17] + 2842 * x[16] + 1559 * x[15] + 2143 * x[14] + 3008 * x[13] + 981 * x[19] == 1306983,
    1290 * x[18] + 3822 * x[17] + 1733 * x[16] + 292 * x[15] + 816 * x[14] + 1017 * x[13] + 3199 * x[19] == 1160573,
    186 * x[18] + 2712 * x[17] + 2136 * x[16] + 98 * x[13] + 138 * x[14] + 3584 * x[15] + 1173 * x[19] == 1005746,
)

# 3. 添加隐含约束：变量为ASCII可打印字符（32≤x[i]≤126），缩小求解范围
for i in range(n):
    solver.add(x[i] >= 32)
    solver.add(x[i] <= 126)

# ======================================
# 2. 求解与结果解析（CTF flag提取）
# ======================================
# 检查约束是否可满足
if solver.check() == sat:
    # 获取求解模型
    model = solver.model()

    # 提取所有变量的整数取值（按x[0]~x[23]顺序）
    solution = [model.eval(x[i]).as_long() for i in range(n)]

    # 转换为ASCII字符（拼接CTF flag）
    flag = ''.join([chr(val) for val in solution])

    # 输出结果
    print("=" * 60)
    print("约束可满足！求解结果如下：")
    print("=" * 60)
    print(f"变量取值（x[0]~x[23]）：{solution}")
    print("\n转换为ASCII字符：")
    for i in range(n):
        print(f"x[{i}] = {solution[i]} → '{chr(solution[i])}'")
    print("\n【CTF最终flag】：", flag)
    print("=" * 60)
else:
    # 异常处理
    print("约束不可满足（unsat），无可行解！")