# 数理逻辑课程作业：基于 TLA+ 的两阶段提交协议形式化验证

## 1. 小组信息

| 姓名 | 学号 | 分工/角色 |
| :--- | :--- | :--- |
| **李祥铭** | **25031212080** | 小组成员 |
| **曹思棋** | **25031212111** | 小组成员 |
| **胡刘静** | **25031212062** | 小组成员 |

---

## 2. 工具介绍与资源

本次作业使用的形式化验证工具为 **TLA+ (Temporal Logic of Actions)**。

*   **工具名称**：TLA+ Toolbox / TLC Model Checker
*   **官方主页**：[The TLA+ Home Page](https://lamport.azurewebsites.net/tla/tla.html)
*   **GitHub 仓库**：[tlaplus/tlaplus](https://github.com/tlaplus/tlaplus)

**工具简介**：
TLA+ 是一门用于对并发系统和分布式系统进行精确建模和验证的高级语言。它由图灵奖得主 Leslie Lamport 设计，旨在帮助工程师在编写代码之前，通过数学语言（集合论和时序逻辑）清晰地定义系统行为，并利用模型检查器（Model Checker）穷举所有可能的状态，以发现设计中的逻辑缺陷。

---

## 3. 项目概述

本项目选取了分布式系统中最经典的 **两阶段提交协议（Two-Phase Commit, 2PC）** 作为案例进行建模与验证。

我们构建了以下两个核心模块：
1.  **`TwoPhase.tla`**：描述了协议的具体实现，包括事务管理器（TM）和资源管理器（RM）的状态流转、消息传递机制以及故障模拟（如 `RMChooseToAbort`）。
2.  **`TCommit.tla`**：作为高层抽象规范，定义了事务提交的全局一致性要求（即 `TCConsistent`）。

通过运行 TLC 模型检查器，我们验证了在 80 种唯一的系统状态流转中，`TwoPhase` 的实现严格满足 `TCommit` 定义的一致性规范，证明了该协议在原子性上的正确性。

---

## 4. 工具搭建与建模后的思考

通过本次使用 TLA+ 对两阶段提交协议进行建模和验证，我们小组对“形式化方法”与“软件工程”的关系有了更深刻的理解，主要体现在以下几个方面：

### 4.1 思维方式的转变：从“怎么做”到“做什么”
传统的编程关注的是代码实现（Implementation），即“如何通过 if-else 实现逻辑”；而 TLA+ 强迫我们关注系统规范（Specification），即“系统在数学上应该表现为什么样”。
在案例中，我们将 RM 和 TM 的交互抽象为状态机。这种思维方式让我们意识到：**清晰地思考比快速地编码更重要**。很多时候，系统的不稳定性并非源于代码写错了，而是源于最初的设计逻辑就存在漏洞（例如未考虑网络分区的边界情况）。

### 4.2 穷举验证的力量：发现人类直觉的盲区
分布式系统的难点在于并发和故障的非确定性。在 PPT 案例中，我们看到 TLC 检查器在极短时间内遍历了所有可能的执行路径。
*   **结果显示**：中止路径（20条）远多于提交路径（1条）。
*   **思考**：这揭示了分布式协议对故障的敏感性。依靠人工测试很难覆盖所有时序组合（Interleaving），而 TLA+ 的模型检查器通过穷举搜索，能帮我们在写第一行代码前就排除“理论上存在但极难复现”的深层 Bug（如死锁或数据不一致）。

### 4.3 抽象与实现的桥梁
我们在项目中定义了 `TPSpec => TC!TCSpec` 的定理。这展示了形式化方法的精髓：**Refinement（求精）**。
*   `TCommit` 是上帝视角的“底线规则”（不能有人提交且有人中止）。
*   `TwoPhase` 是具体的“操作流程”。
通过数学证明二者的蕴含关系，我们不仅验证了代码逻辑，更验证了设计意图的一致性。

### 4.4 工业界的实际价值
TLA+ 并非仅存在于象牙塔中的理论玩具。正如调研所见，Amazon AWS 和 Microsoft Azure 都在核心基础设施（如 S3、Cosmos DB）中使用 TLA+。这让我们认识到，对于那些“出错代价极高”的关键系统，投入时间进行形式化建模是降低工程风险、提升软件可靠性的最高效手段。

---

**总结**：本次作业不仅让我们掌握了 TLA+ 的基本语法和 TLC 工具的使用，更重要的是建立了一种**“验证驱动设计”**的工程价值观——在构建复杂系统时，先用数学证明其正确性，再动手实现。
